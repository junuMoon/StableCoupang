openapi: 3.0.3
info:
  title: StableCoupang API
  description: |
    XRP Ledger 기반의 리뷰 리워드 서비스 API

    AI가 평가한 리뷰 품질에 따라 KRW 토큰 리워드를 즉시 지급합니다.

    주요 기능:
    - 제품 리뷰 작성 (텍스트 + 이미지)
    - Google Gemini AI 기반 리뷰 품질 자동 평가 (0-100점)
    - 평가 점수에 따른 KRW 스테이블코인 리워드 즉시 지급
    - 사용자별 신뢰도(Reputation Score) 관리
    - XRP Ledger 기반 지갑 자동 생성 및 토큰 관리
  version: 1.0.0
  contact:
    name: StableCoupang Team

servers:
  - url: http://localhost:3001
    description: 로컬 개발 서버

tags:
  - name: Auth
    description: 인증 관련 API
  - name: Products
    description: 제품 관리 API
  - name: Reviews
    description: 리뷰 관리 API
  - name: Users
    description: 사용자 정보 API

security:
  - BearerAuth: []

paths:
  # Auth API
  /api/register:
    post:
      tags:
        - Auth
      summary: 회원가입
      description: |
        신규 사용자 회원가입 및 XRP 지갑 자동 생성
        - XRP Ledger 지갑 자동 생성
        - Trust Line 설정
        - 비밀번호 bcrypt 해싱
        - XRP Seed AES-256-CBC 암호화
      operationId: register
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  description: 이메일 주소
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  description: 비밀번호 (최소 8자)
                  example: password123
                name:
                  type: string
                  description: 사용자 이름 (선택)
                  example: 홍길동
      responses:
        '200':
          description: 회원가입 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 회원가입이 완료되었습니다
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                        example: clxyz123abc
                      email:
                        type: string
                        example: user@example.com
                      name:
                        type: string
                        example: 홍길동
                      xrpAddress:
                        type: string
                        example: rN7n7otQDd6FczFgLdlqtyMVrn3yMNxdZ
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/auth/callback/credentials:
    post:
      tags:
        - Auth
      summary: 로그인
      description: 이메일/비밀번호 기반 로그인 (NextAuth)
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  token:
                    type: string
                    description: JWT 토큰
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # Product API
  /api/products:
    get:
      tags:
        - Products
      summary: 제품 목록 조회
      description: 등록된 전체 제품 목록 조회
      operationId: getProducts
      security: []
      parameters:
        - name: page
          in: query
          description: 페이지 번호 (1부터 시작)
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: 페이지당 항목 수
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: 제품 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Products
      summary: 제품 등록
      description: 관리자가 신규 제품 등록
      operationId: createProduct
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  description: 제품명
                  example: 무선 이어폰 프로
                description:
                  type: string
                  description: 제품 설명
                  example: 프리미엄 노이즈 캔슬링 무선 이어폰
                imageUrl:
                  type: string
                  format: uri
                  description: 제품 이미지 URL
                  example: https://example.com/product.jpg
                price:
                  type: integer
                  description: 가격 (원 단위)
                  example: 150000
      responses:
        '201':
          description: 제품 등록 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/products/{id}:
    get:
      tags:
        - Products
      summary: 제품 상세 조회
      description: 특정 제품의 상세 정보 조회
      operationId: getProductById
      security: []
      parameters:
        - name: id
          in: path
          required: true
          description: 제품 ID
          schema:
            type: string
            example: clxyz123abc
      responses:
        '200':
          description: 제품 상세 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Product'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # Review API
  /api/reviews:
    get:
      tags:
        - Reviews
      summary: 리뷰 피드 조회
      description: 전체 리뷰 타임라인 (최신순)
      operationId: getReviews
      security: []
      parameters:
        - name: page
          in: query
          description: 페이지 번호
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: 페이지당 항목 수
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
      responses:
        '200':
          description: 리뷰 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Review'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Reviews
      summary: 리뷰 작성
      description: |
        제품 리뷰 작성 및 AI 평가/리워드 지급

        프로세스:
        1. 이미지 업로드 (최대 3장)
        2. Google Gemini AI로 리뷰 품질 평가 (0-100점)
        3. 평가 점수 기반 KRW 토큰 리워드 자동 지급
        4. 사용자 신뢰도 점수 갱신
      operationId: createReview
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - productId
                - text
              properties:
                productId:
                  type: string
                  description: 제품 ID
                  example: clxyz123abc
                text:
                  type: string
                  minLength: 10
                  description: 리뷰 텍스트 (최소 10자)
                  example: 노이즈 캔슬링 기능이 정말 뛰어나고, 배터리도 하루 종일 사용 가능합니다. 통화 품질도 우수합니다.
                images:
                  type: array
                  items:
                    type: string
                    format: binary
                  maxItems: 3
                  description: 리뷰 이미지 (최대 3장)
      responses:
        '201':
          description: 리뷰 작성 및 리워드 지급 완료
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      review:
                        $ref: '#/components/schemas/Review'
                      aiScore:
                        type: integer
                        description: AI 평가 점수 (0-100)
                        example: 78
                      rewardAmount:
                        type: integer
                        description: 지급된 리워드 (KRW)
                        example: 780
                      newBalance:
                        type: integer
                        description: 현재 KRW 잔액
                        example: 1280
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/reviews/{id}:
    get:
      tags:
        - Reviews
      summary: 리뷰 상세 조회
      description: 특정 리뷰의 상세 정보 조회
      operationId: getReviewById
      security: []
      parameters:
        - name: id
          in: path
          required: true
          description: 리뷰 ID
          schema:
            type: string
            example: clxyz456def
      responses:
        '200':
          description: 리뷰 상세 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Review'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/products/{id}/reviews:
    get:
      tags:
        - Reviews
      summary: 특정 제품의 리뷰 목록
      description: 특정 제품에 작성된 리뷰 목록 조회
      operationId: getProductReviews
      security: []
      parameters:
        - name: id
          in: path
          required: true
          description: 제품 ID
          schema:
            type: string
            example: clxyz123abc
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
      responses:
        '200':
          description: 제품 리뷰 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Review'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # User API
  /api/users/me:
    get:
      tags:
        - Users
      summary: 내 프로필 조회
      description: 현재 로그인한 사용자의 프로필 정보 조회 (잔액, 신뢰도 점수 포함)
      operationId: getMyProfile
      responses:
        '200':
          description: 프로필 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/users/me/reviews:
    get:
      tags:
        - Users
      summary: 내 리뷰 목록
      description: 현재 로그인한 사용자가 작성한 리뷰 목록 조회
      operationId: getMyReviews
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
      responses:
        '200':
          description: 내 리뷰 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Review'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/users/me/rewards:
    get:
      tags:
        - Users
      summary: 내 리워드 히스토리
      description: 현재 로그인한 사용자의 리워드 지급 내역 조회
      operationId: getMyRewards
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: 리워드 내역 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RewardHistory'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/users/me/balance:
    get:
      tags:
        - Users
      summary: KRW/XRP 잔액 조회
      description: 현재 로그인한 사용자의 XRP Ledger 지갑 잔액 조회
      operationId: getMyBalance
      responses:
        '200':
          description: 잔액 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      xrpAddress:
                        type: string
                        description: XRP 지갑 주소
                        example: rN7n7otQDd6FczFgLdlqtyMVrn3yMNxdZ
                      balances:
                        type: object
                        properties:
                          XRP:
                            type: string
                            description: XRP 잔액
                            example: "100.5"
                          KRW:
                            type: string
                            description: KRW 토큰 잔액
                            example: "50000"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: NextAuth JWT 토큰

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          description: 사용자 ID
          example: clxyz123abc
        email:
          type: string
          format: email
          description: 이메일 주소
          example: user@example.com
        name:
          type: string
          nullable: true
          description: 사용자 이름
          example: 홍길동
        xrpAddress:
          type: string
          description: XRP 지갑 주소
          example: rN7n7otQDd6FczFgLdlqtyMVrn3yMNxdZ
        reputationScore:
          type: number
          format: float
          description: 신뢰도 점수 (평균 리뷰 점수)
          example: 75.5
        createdAt:
          type: string
          format: date-time
          description: 가입일
          example: "2025-01-01T00:00:00Z"

    UserProfile:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            totalReviews:
              type: integer
              description: 작성한 총 리뷰 수
              example: 12
            totalRewards:
              type: integer
              description: 받은 총 리워드 금액 (KRW)
              example: 8540
            balances:
              type: object
              properties:
                XRP:
                  type: string
                  example: "100.5"
                KRW:
                  type: string
                  example: "8540"

    Product:
      type: object
      properties:
        id:
          type: string
          description: 제품 ID
          example: clxyz123abc
        name:
          type: string
          description: 제품명
          example: 무선 이어폰 프로
        description:
          type: string
          nullable: true
          description: 제품 설명
          example: 프리미엄 노이즈 캔슬링 무선 이어폰
        imageUrl:
          type: string
          format: uri
          nullable: true
          description: 제품 이미지 URL
          example: https://example.com/product.jpg
        price:
          type: integer
          nullable: true
          description: 가격 (원 단위)
          example: 150000
        createdAt:
          type: string
          format: date-time
          description: 등록일
          example: "2025-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: 수정일
          example: "2025-01-01T00:00:00Z"

    Review:
      type: object
      properties:
        id:
          type: string
          description: 리뷰 ID
          example: clxyz456def
        userId:
          type: string
          description: 작성자 ID
          example: clxyz123abc
        productId:
          type: string
          description: 제품 ID
          example: clxyz123abc
        text:
          type: string
          description: 리뷰 텍스트
          example: 노이즈 캔슬링 기능이 정말 뛰어나고, 배터리도 하루 종일 사용 가능합니다.
        images:
          type: array
          items:
            type: string
          description: 이미지 파일 경로 배열
          example: ["/uploads/reviews/image1.jpg", "/uploads/reviews/image2.jpg"]
        aiScore:
          type: integer
          minimum: 0
          maximum: 100
          description: AI 평가 점수 (0-100)
          example: 78
        rewardAmount:
          type: integer
          description: 지급된 리워드 (KRW)
          example: 780
        createdAt:
          type: string
          format: date-time
          description: 작성일
          example: "2025-01-05T14:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: 수정일
          example: "2025-01-05T14:30:00Z"
        user:
          $ref: '#/components/schemas/User'
        product:
          $ref: '#/components/schemas/Product'

    RewardHistory:
      type: object
      properties:
        id:
          type: string
          description: 리워드 내역 ID
          example: clxyz789ghi
        userId:
          type: string
          description: 사용자 ID
          example: clxyz123abc
        reviewId:
          type: string
          nullable: true
          description: 리뷰 ID (리뷰 관련 리워드인 경우)
          example: clxyz456def
        amount:
          type: integer
          description: 지급 금액 (KRW)
          example: 780
        type:
          type: string
          description: 리워드 타입
          enum: [review, bonus]
          example: review
        createdAt:
          type: string
          format: date-time
          description: 지급일
          example: "2025-01-05T14:30:00Z"

    Pagination:
      type: object
      properties:
        page:
          type: integer
          description: 현재 페이지
          example: 1
        limit:
          type: integer
          description: 페이지당 항목 수
          example: 20
        total:
          type: integer
          description: 전체 항목 수
          example: 150
        totalPages:
          type: integer
          description: 전체 페이지 수
          example: 8

    Error:
      type: object
      properties:
        error:
          type: string
          description: 에러 메시지
          example: 잘못된 요청입니다

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 필수 파라미터가 누락되었습니다

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 인증이 필요합니다

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 요청한 리소스를 찾을 수 없습니다

    InternalError:
      description: 서버 내부 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 서버 오류가 발생했습니다
